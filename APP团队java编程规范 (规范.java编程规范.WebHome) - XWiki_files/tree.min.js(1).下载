define(["jquery","JobRunner","jsTree","tree-finder"],function(l,q){l.jstree.idregex=/[\\:&!^|()\[\]<>@*'+~#";.,=\- \/${}%?`]/g;var d=l("meta[name=form_token]").attr("content");var g=function(F){var E={};l.each(F,function(){if(this.data&&typeof this.data.type==="string"){E[this.data.type]=true}});var G=[];for(var H in E){E.hasOwnProperty(H)&&G.push(H)}return G};var i=function(H,I,G){I=l.proxy(I,this);if(H.id==="#"&&!H.data){var F=I;I=function(K){var J=g(K);if(J.length>0){H.data={validChildren:J}}F(K)}}var E=H.data&&H.data.childrenURL;G=G||{};if(!E){E=this.element.attr("data-url");G=l.extend({data:"children",id:H.id},G)}if(E){l.get(E,G).done(I).fail(function(){I([])})}else{I([])}};var x=function(E,F){return !E.data||!E.data.validChildren||(F.data&&E.data.validChildren.indexOf(F.data.type)>=0)};var a=function(E,H){for(var F=0;F<E.length;F++){var G=E[F];if(!G.data||!G.data["can"+H]){return false}}return true};var o=function(E){return a(E,"Copy")};var k=function(E){return a(E,"Move")};var t=function(E){return a(E,"Delete")};var b=function(F,I,H,E,G){return(F==="create_node"&&x(H,I))||(F==="rename_node"&&I.data&&I.data.canRename)||(F==="delete_node"&&I.data&&I.data.canDelete)||(F==="move_node"&&I.data&&I.data.canMove&&x(H,I))||(F==="copy_node"&&I.data&&I.data.canCopy&&x(H,I))};var j=function(E){for(var F=0;F<E.length;F++){var G=E[F];if(!G.data||!G.data.draggable){return false}}return true};var u=function(E,H){var F=E.get_node(H.id,true);if(F.hasClass("jstree-loading")){return}F.addClass("jstree-loading");var G=E.get_node(H.parent);i.call(E,G,function(J){var I=F.parent().children().index(F[0]);E.delete_node(H);l.each(J,function(K){!E.get_node(this)&&E.create_node(G,this,I+K,K===0&&function(L){E.select_node(L)})})},{offset:H.data.offset})};var D=function(E,F){E.get_node(F,true).addClass("jstree-loading");E.disable_node(F)};var c=function(E,F){E.get_node(F,true).removeClass("jstree-loading");E.enable_node(F)};var v=function(F){var E=l(F).attr("data-url");return new q({createStatusRequest:function(G){return{url:E,data:{id:G,data:"jobStatus"}}},createAnswerRequest:function(G,H){return{url:E,data:l.extend({},H,{id:G,action:"answer",form_token:d})}}})};var h=function(E,F){var G={name:F.text};if(F.data&&F.data.type){G.type=F.data.type}return E.execute("create",E.get_node(F.parent),G)};var w=function(E,F){return E.execute("delete",F)};var m=function(E,F){return E.execute("move",F,{parent:F.parent,name:F.text})};var C=function(E,G,F){return E.execute("copy",G,{parent:F})};var B=function(H,K){if(!H.data||!H.data.hasContextMenu){return}var E=this;var I=function(L){E.element.trigger("xtree.openContextMenu",{tree:E,node:H,menu:L});K.call(E,L)};if(H.data.contextMenuURL){E.contextMenuByURL=E.contextMenuByURL||{};var J=E.contextMenuByURL[H.data.contextMenuURL];if(J){I(J)}else{var G=H.data.contextMenuURL;l.get(G,function(L){E.contextMenuByURL[G]=z(L);I(L)})}}else{if(E.contextMenuByNodeType){I(E.contextMenuByNodeType[H.data.type])}else{var F=H.data.type;l.get(E.element.attr("data-url"),{data:"contextMenu"},function(L){E.contextMenuByNodeType=f(L);I(E.contextMenuByNodeType[F])})}}};var f=function(F){for(var E in F){if(F.hasOwnProperty(E)){z(F[E])}}return F};var z=function(H){for(var F in H){if(H.hasOwnProperty(F)){var G=H[F];var E=G.action||F;G.action=n(E,G.parameters)}}return H};var n=function(F,E){return function(H){var G=l.jstree.reference(H.reference);H.parameters=l.extend(true,{},E||{});G.element.trigger("xtree.contextMenu."+F,H)}};var s=function(G,F){var E={text:"New Child",children:false,data:{type:G.data&&G.data.validChildren&&G.data.validChildren[0],canRename:true,canDelete:true}};return l.extend(true,E,F||{})};var e=function(F,G){G=l.proxy(G,this);if(this.get_node(F)){G(this.get_path(F,false,true))}else{var E=this.element.attr("data-url");if(E){l.get(E,{data:"path",id:F}).done(G).fail(function(){G([])})}else{G([])}}};var y=function(F,G,I){if(G&&G.length>0){var H=this.get_node(G[0]);var E=this.get_children_dom(F);if(!H&&x(F,G[0])&&E.length>0&&this.get_node(E.last()).data.type==="pagination"){H=this.get_node(this.create_node(F,G[0],E.length-1))}if(H){return this.open_node(H,function(){y.call(this,H,G.slice(1),I)})}}I&&I(F)};var r=function(E,F){E+=E.indexOf("?")<0?"?":"&";return E+l.param(F)};var A=function(F){var G={core:{force_text:true,animation:false,themes:{name:"xwiki",responsive:F.attr("data-responsive")!=="false",icons:F.attr("data-icons")!=="false",dots:F.attr("data-edges")!=="false"}}};var E=[];if(F.attr("data-checkboxes")==="true"){E.push("checkbox")}if(F.attr("data-url")){if(F.attr("data-dragAndDrop")==="true"){E.push("dnd")}if(F.attr("data-contextMenu")==="true"){E.push("contextmenu")}if(F.attr("data-finder")==="true"){E.push("finder")}return l.extend(true,G,{core:{data:i,check_callback:b},plugins:E,dnd:{is_draggable:j},contextmenu:{items:B},finder:{url:r(F.attr("data-url"),{data:"suggestions"})}})}else{G.plugins=E;return G}};var p={openTo:function(E,F){F=F||l.proxy(this,"select_node");e.call(this,E,function(H){var G=this.get_node("#");y.call(this,G,H,F)})},refreshNode:function(E){if(E==="#"){this.refresh()}else{this.refresh_node(E)}},execute:function(G,F,I){var E=F.data&&F.data[G+"URL"];I=I||{};if(!E){E=this.element.attr("data-url");I.action=G;I.id=F.id}I.form_token=d;var H=this.jobRunner.run(E,I);this.element.trigger("xtree.runJob",H);return H}};l.fn.xtree=function(E){return this.on("select_node.jstree",function(G,I){var F=I.instance;var H=I.node;if(H.data&&H.data.type==="pagination"){u(F,H)}else{if(I.event&&!l(I.event.target).hasClass("jstree-no-link")&&l(I.event.target).closest(".jstree-no-links").length===0){window.location.href=H.a_attr.href}}}).on("open_node.jstree",function(G,H){var F=H.node.original;F&&F.iconOpened&&H.instance.set_icon(H.node,F.iconOpened)}).on("close_node.jstree",function(G,H){var F=H.node.original;F&&F.iconOpened&&H.instance.set_icon(H.node,F.icon)}).on("create_node.jstree",function(F,G){}).on("rename_node.jstree",function(G,H){var F=H.node.data&&H.node.data.id;if(F){if(H.old!=H.text){D(H.instance,H.node);m(H.instance,H.node).always(function(){H.instance.refreshNode(H.node.parent)})}}else{D(H.instance,H.node);h(H.instance,H.node).done(function(){H.instance.refreshNode(H.node.parent)}).fail(function(){H.instance.delete_node(H.node)})}}).on("delete_node.jstree",function(G,H){var F=H.node.data&&H.node.data.id;F&&w(H.instance,H.node).fail(function(){H.instance.refreshNode(H.parent)})}).on("move_node.jstree",function(G,H){var F=H.node.data&&H.node.data.id;if(!F||H.parent===H.old_parent){return}D(H.instance,H.node);m(H.instance,H.node).done(function(){H.instance.refreshNode(H.parent)}).fail(function(I){H.node.data.id=null;H.instance.move_node(H.node,H.old_parent,H.old_position);setTimeout(function(){H.node.data.id=F;c(H.instance,H.node)},0)})}).on("copy_node.jstree",function(G,H){var F=H.original.data&&H.original.data.id;if(!F){return}D(H.instance,H.node);H.node.data=l.extend(true,{},H.original.data);delete H.node.data.id;C(H.instance,H.original,H.parent).done(function(){H.instance.refreshNode(H.parent)}).fail(function(I){H.instance.delete_node(H.node)})}).on("xtree.contextMenu.refresh",function(H,I){var F=l.jstree.reference(I.reference);var G=F.get_node(I.reference);F.refreshNode(G)}).on("xtree.contextMenu.create",function(I,J){var F=l.jstree.reference(J.reference);var H=F.get_node(J.reference);var G=s(H,J.parameters.template);F.create_node(H,G,"first",function(K){setTimeout(function(){F.edit(K)},0)})}).on("xtree.contextMenu.cut",function(G,H){var F=l.jstree.reference(H.reference);F.cut(F.get_selected())}).on("xtree.contextMenu.copy",function(G,H){var F=l.jstree.reference(H.reference);F.copy(F.get_selected())}).on("xtree.contextMenu.paste",function(H,I){var F=l.jstree.reference(I.reference);var G=F.get_node(I.reference);F.paste(G)}).on("xtree.contextMenu.rename",function(H,I){var F=l.jstree.reference(I.reference);var G=F.get_node(I.reference);setTimeout(function(){F.edit(G)},0)}).on("xtree.contextMenu.remove",function(G,H){var F=H.parameters.confirmationMessage===false;var I=H.parameters.confirmationMessage||"Are you sure you want to delete the selected nodes?";setTimeout(function(){if(F||window.confirm(I)){var J=l.jstree.reference(H.reference);J.delete_node(J.get_selected())}},0)}).on("xtree.contextMenu.openLink",function(H,I){var F=l.jstree.reference(I.reference);if(I.parameters.urlProperty){var G=F.get_node(I.reference);window.location=G.data[I.parameters.urlProperty]}else{var J=F.get_node(I.reference,true);window.location=J.children("a.jstree-anchor").prop("href")}}).on("xtree.contextMenu.openLinkInNewTab",function(H,I){var F=l.jstree.reference(I.reference);var G=F.get_node(I.reference,true);window.open(G.children("a.jstree-anchor").prop("href"))}).on("xtree.openContextMenu",function(F,G){var H=G.tree.get_selected(true);if(G.menu.copy){G.menu.copy._disabled=!o(H)}if(G.menu.cut){G.menu.cut._disabled=!k(H)}if(G.menu.paste){G.menu.paste._disabled=!G.tree.can_paste()}if(G.menu.rename){G.menu.rename._disabled=!G.node.data||!G.node.data.canRename}if(G.menu.remove){G.menu.remove._disabled=!t(H)}}).each(function(){l(this).jstree(l.extend(true,A(l(this)),E||{}));l.extend(l.jstree.reference(this),p,{jobRunner:v(this)})})};return l});